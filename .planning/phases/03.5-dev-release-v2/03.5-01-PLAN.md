---
phase: 03.5-dev-release-v2
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - openshift-pipelines/pac-downstream:release-v1.15.x:.konflux/dockerfiles/controller.Dockerfile
  - openshift-pipelines/pac-downstream:release-v1.15.x:.konflux/dockerfiles/watcher.Dockerfile
  - openshift-pipelines/pac-downstream:release-v1.15.x:.konflux/dockerfiles/cli.Dockerfile
  - openshift-pipelines/p12n-manual-approval-gate:release-v1.15.x:.konflux/dockerfiles/controller.Dockerfile
  - openshift-pipelines/p12n-manual-approval-gate:release-v1.15.x:.konflux/dockerfiles/webhook.Dockerfile
autonomous: true

must_haves:
  truths:
    - "All 5 Dockerfiles have CPE label with correct format"
    - "PRs merged to release-v1.15.x branches"
    - "Konflux on-push pipelines triggered for both components"
  artifacts:
    - path: "pac-downstream PR"
      provides: "CPE labels for controller, watcher, cli Dockerfiles"
      contains: 'cpe="cpe:/a:redhat:openshift_pipelines:1.15::el8"'
    - path: "p12n-manual-approval-gate PR"
      provides: "CPE labels for controller, webhook Dockerfiles"
      contains: 'cpe="cpe:/a:redhat:openshift_pipelines:1.15::el8"'
  key_links:
    - from: "Dockerfile LABEL"
      to: "Konflux build"
      via: "on-push pipeline trigger"
      pattern: "PR merge -> Konflux rebuild"
---

<objective>
Add missing CPE labels to 5 Dockerfiles in pac-downstream and p12n-manual-approval-gate repositories.

Purpose: Stage/prod release will fail if `enforceContainerFirstSecurityLabels: true` is enabled and Dockerfiles lack CPE labels. These 5 Dockerfiles are the only ones missing the label.

Output: 2 PRs merged to release-v1.15.x branches, Konflux rebuilds triggered.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.5-dev-release-v2/03.5-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CPE label to pac-downstream Dockerfiles</name>
  <files>
    - openshift-pipelines/pac-downstream:.konflux/dockerfiles/controller.Dockerfile
    - openshift-pipelines/pac-downstream:.konflux/dockerfiles/watcher.Dockerfile
    - openshift-pipelines/pac-downstream:.konflux/dockerfiles/cli.Dockerfile
  </files>
  <action>
    Create a PR against release-v1.15.x branch in openshift-pipelines/pac-downstream.

    For each of the 3 Dockerfiles (controller, watcher, cli), add the CPE label to the existing LABEL block:
    ```dockerfile
    cpe="cpe:/a:redhat:openshift_pipelines:1.15::el8"
    ```

    The label should be added after the existing labels in the LABEL instruction. Ensure proper line continuation with backslash.

    **Branch:** release-v1.15.x (NOT main)
    **PR title:** "Add CPE label to Dockerfiles for release-v1.15.x"
    **PR body:** "Adds missing CPE label required for stage/prod release. enforceContainerFirstSecurityLabels will be enabled in Konflux release data."

    Use gh CLI to create the PR:
    1. Clone repo or use GitHub API
    2. Create branch from release-v1.15.x
    3. Edit the 3 Dockerfiles
    4. Create PR targeting release-v1.15.x
    5. Wait for Konflux PR pipeline to pass
    6. Merge PR (admin merge if needed)
  </action>
  <verify>
    - PR merged to release-v1.15.x
    - Konflux on-push pipeline triggered (check GitHub Actions or Konflux UI)
    - `gh pr view --repo openshift-pipelines/pac-downstream` shows merged status
  </verify>
  <done>
    3 Dockerfiles in pac-downstream have CPE label, PR merged, Konflux rebuild triggered
  </done>
</task>

<task type="auto">
  <name>Task 2: Add CPE label to p12n-manual-approval-gate Dockerfiles</name>
  <files>
    - openshift-pipelines/p12n-manual-approval-gate:.konflux/dockerfiles/controller.Dockerfile
    - openshift-pipelines/p12n-manual-approval-gate:.konflux/dockerfiles/webhook.Dockerfile
  </files>
  <action>
    Create a PR against release-v1.15.x branch in openshift-pipelines/p12n-manual-approval-gate.

    For each of the 2 Dockerfiles (controller, webhook), add the CPE label to the existing LABEL block:
    ```dockerfile
    cpe="cpe:/a:redhat:openshift_pipelines:1.15::el8"
    ```

    The label should be added after the existing labels in the LABEL instruction. Ensure proper line continuation with backslash.

    **Branch:** release-v1.15.x (NOT main)
    **PR title:** "Add CPE label to Dockerfiles for release-v1.15.x"
    **PR body:** "Adds missing CPE label required for stage/prod release. enforceContainerFirstSecurityLabels will be enabled in Konflux release data."

    Use gh CLI to create the PR:
    1. Clone repo or use GitHub API
    2. Create branch from release-v1.15.x
    3. Edit the 2 Dockerfiles
    4. Create PR targeting release-v1.15.x
    5. Wait for Konflux PR pipeline to pass
    6. Merge PR (admin merge if needed)
  </action>
  <verify>
    - PR merged to release-v1.15.x
    - Konflux on-push pipeline triggered
    - `gh pr view --repo openshift-pipelines/p12n-manual-approval-gate` shows merged status
  </verify>
  <done>
    2 Dockerfiles in p12n-manual-approval-gate have CPE label, PR merged, Konflux rebuild triggered
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. All 5 Dockerfiles have CPE label on release-v1.15.x branch
2. Both PRs merged (not just approved)
3. Konflux on-push pipelines triggered for both repos
4. No pipeline failures

Verification commands:
```bash
# Check pac-downstream
gh api repos/openshift-pipelines/pac-downstream/contents/.konflux/dockerfiles/controller.Dockerfile?ref=release-v1.15.x | jq -r '.content' | base64 -d | grep -c 'cpe='

# Check p12n-manual-approval-gate
gh api repos/openshift-pipelines/p12n-manual-approval-gate/contents/.konflux/dockerfiles/controller.Dockerfile?ref=release-v1.15.x | jq -r '.content' | base64 -d | grep -c 'cpe='
```
</verification>

<success_criteria>
- [ ] pac-downstream: 3 Dockerfiles have CPE label
- [ ] p12n-manual-approval-gate: 2 Dockerfiles have CPE label
- [ ] Both PRs merged to release-v1.15.x
- [ ] Konflux on-push pipelines triggered (may still be running)
</success_criteria>

<output>
After completion, create `.planning/phases/03.5-dev-release-v2/03.5-01-SUMMARY.md`

Include:
- PR numbers and URLs for both repos
- Files modified
- Konflux pipeline status
- Any issues encountered
</output>
