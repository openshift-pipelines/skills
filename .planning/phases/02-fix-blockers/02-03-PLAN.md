---
phase: 02-fix-blockers
plan: 03
type: execute
---

<objective>
Diagnose and fix the Konflux pipeline failure on PR #903 (oauth2 CVE fix) so it can be merged.

Purpose: PR #903 contains the oauth2 CVE fix required for 1.15.4 release. The Konflux pipeline is failing, blocking merge. Need to identify root cause and fix it.
Output: PR #903 pipeline passing and PR mergeable (or clear action items if fix requires external action).
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/references/checkpoints.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-assessment/01-01-SUMMARY.md
@commands/osp/pr-pipeline-status.md

**From Phase 1 Assessment:**
- PR #903 URL: https://github.com/openshift-pipelines/tektoncd-cli/pull/903
- Contains oauth2 fix (v0.27.0) from upstream release-v0.37.2
- State: OPEN, Mergeable
- Konflux Pipeline: FAILING (needs diagnosis)

**Available Skills:**
- `/osp:pr-pipeline-status` - Diagnoses Konflux and GitHub Actions failures
- `/osp:configure` - Sets up Konflux authentication if needed

**PR Context:**
- Repository: openshift-pipelines/tektoncd-cli
- Target branch: release-v1.15.x
- This PR must merge before dev release can proceed
</context>

<tasks>

<task type="auto">
  <name>Task 1: Diagnose PR #903 pipeline failure</name>
  <files>None (API calls only)</files>
  <action>
Use the `/osp:pr-pipeline-status` skill to diagnose the failure:

1. Run: `/osp:pr-pipeline-status openshift-pipelines/tektoncd-cli 903`
2. The skill will:
   - Fetch all check runs for the PR
   - Identify failing Konflux pipelines
   - Parse the failure details URL
   - Categorize the failure pattern (base image, EC, build, dependency)
   - Provide specific fix recommendations

If skill prompts for Konflux authentication:
- Try the "manual check" option first - open the details_url in browser
- Look for the failed TaskRun and error message
- Common Konflux failures: base image SHA not found, EC validation, build error

**Record findings:**
- Which pipeline failed (name)
- Error type (base image / EC / build / dependency / other)
- Specific error message
- Recommended fix from skill
  </action>
  <verify>
Diagnosis complete when:
- Error type identified
- Specific error message captured
- Fix approach determined
  </verify>
  <done>PR #903 failure diagnosed with clear error type and fix approach documented</done>
</task>

<task type="checkpoint:decision" gate="blocking">
  <decision>Select fix approach based on diagnosis</decision>
  <context>
The diagnosis from Task 1 will reveal what's broken. Based on common Konflux failure patterns, the fix will likely be one of these:

- **Base image not found:** Update Dockerfile SHA to current registry.redhat.io SHA
- **EC validation failure:** Fix policy violation (labels, signing, etc.)
- **Build error:** Fix code compilation issue
- **Dependency error:** Update go.mod/go.sum
- **Transient failure:** Re-trigger pipeline

Some fixes can be automated by Claude; others require user action or external changes.
  </context>
  <options>
    <option id="fix-and-push">
      <name>Fix in PR and push</name>
      <pros>Claude can make the fix directly (base image update, go.mod, etc.)</pros>
      <cons>Requires push access to PR branch; may need additional review</cons>
    </option>
    <option id="retrigger-only">
      <name>Just re-trigger pipeline</name>
      <pros>If transient failure, no code change needed</pros>
      <cons>Won't help if there's a real issue</cons>
    </option>
    <option id="manual-fix">
      <name>User handles fix manually</name>
      <pros>User has context/access that Claude lacks</pros>
      <cons>Blocks automated workflow</cons>
    </option>
    <option id="escalate">
      <name>Escalate to maintainer</name>
      <pros>Issue requires maintainer attention (EC policy, infra)</pros>
      <cons>Adds delay waiting for response</cons>
    </option>
  </options>
  <resume-signal>Select: fix-and-push, retrigger-only, manual-fix, or escalate (based on diagnosis)</resume-signal>
</task>

<task type="auto">
  <name>Task 3: Apply fix (if fix-and-push selected)</name>
  <files>Depends on diagnosis - likely .konflux/dockerfiles/*.Dockerfile or go.mod</files>
  <action>
**If fix-and-push selected:**

Based on diagnosis, apply the appropriate fix:

**For base image SHA issue:**
```bash
# Clone PR branch
git clone https://github.com/openshift-pipelines/tektoncd-cli.git --branch PR_BRANCH --depth=1
cd tektoncd-cli

# Find current valid SHA
CURRENT_SHA=$(skopeo inspect docker://registry.redhat.io/ubi8/ubi-minimal:latest --no-tags 2>/dev/null | jq -r '.Digest')
echo "Current valid SHA: $CURRENT_SHA"

# Update Dockerfile with new SHA
# Edit the appropriate .konflux/dockerfiles/*.Dockerfile
# Replace old SHA with new one

git add .
git commit -m "fix: update base image SHA for Konflux build"
git push
```

**For dependency issue:**
```bash
cd tektoncd-cli
go mod tidy
git add go.mod go.sum
git commit -m "fix: update go.mod dependencies"
git push
```

**For retrigger-only:**
```bash
# Add empty commit to retrigger
cd tektoncd-cli
git commit --allow-empty -m "chore: retrigger Konflux pipeline"
git push
```

**For manual-fix or escalate:**
Document what needs to be done and by whom.
  </action>
  <verify>
```bash
# Check PR has new commit
gh pr view 903 --repo openshift-pipelines/tektoncd-cli --json commits --jq '.commits[-1].messageHeadline'

# Watch for pipeline to start
gh pr checks 903 --repo openshift-pipelines/tektoncd-cli
```
  </verify>
  <done>Fix pushed to PR #903, new pipeline triggered</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Diagnosis complete with error type identified
- [ ] Fix approach selected via checkpoint
- [ ] Fix applied (or documented for manual action)
- [ ] New pipeline triggered on PR #903
</verification>

<success_criteria>

- PR #903 failure diagnosed with specific error type
- Fix approach determined and applied (or escalated with clear action items)
- Pipeline re-triggered after fix
- Path to merge unblocked (even if waiting for pipeline to complete)
</success_criteria>

<output>
After completion, create `.planning/phases/02-fix-blockers/02-03-SUMMARY.md`:

# Phase 2 Plan 3: Diagnose PR #903 Summary

**[One-liner: e.g., "Fixed base image SHA, PR #903 pipeline now passing"]**

## Diagnosis

- **PR:** openshift-pipelines/tektoncd-cli #903
- **Failure Type:** [base image / EC / build / dependency / transient]
- **Error Message:** [specific error]
- **Root Cause:** [explanation]

## Fix Applied

- **Approach:** [fix-and-push / retrigger / manual / escalate]
- **Changes:** [what was changed]
- **Commit:** [SHA if applicable]

## Current Status

- Pipeline: [running / passed / failed]
- PR Mergeable: [yes / no / pending]

## Next Step

[If passed: Ready for merge, then 02-04]
[If still running: Wait for pipeline, then verify in 02-04]
[If escalated: Waiting on {who} for {what}]
</output>
