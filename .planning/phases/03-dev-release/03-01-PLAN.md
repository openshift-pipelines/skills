---
phase: 03-dev-release
plan: 01
type: execute
---

<objective>
Execute development release for OpenShift Pipelines 1.15.4 — generate INDEX images and verify readiness for QE testing.

Purpose: Complete the devel release pipeline (CORE → CLI → OPERATOR → **INDEX**) so QE can test the 1.15.4 patch before stage release.
Output: All index images built and available in quay.io/openshift-pipeline, ready for QE installation testing.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-fix-blockers/02-04-SUMMARY.md

**Prior Phase Context (02-04):**
- All 11 component images verified fresh (<72h)
- Operator bundle updated with fresh images (PR #14206 merged)
- Release build order: CORE → CLI → OPERATOR → INDEX
- Phase 2 completed operator update; INDEX is the remaining step

**Release Order (Critical):**
1. ~~CORE~~ — Pipeline, Triggers, Chains, Results, Hub, PAC, git-clone, console-plugin, MAG (DONE)
2. ~~CLI~~ — tektoncd-cli (DONE)
3. ~~OPERATOR~~ — Operator bundle updated (DONE via PR #14206)
4. **INDEX** — OLM index images for each OCP version (THIS PHASE)

**Target Registry:** `quay.io/openshift-pipeline` (devel environment)

**Skills Available:**
- `/osp:operator-release` — Runs index-render-template workflow
- `/osp:component-builds` — Verifies pipeline status

**Version Info:**
- Release: 1.15.4
- Branch: release-v1.15.x
- Minor: 1.15
</context>

<tasks>

<task type="auto">
  <name>Task 1: Run index-render-template workflow to generate OLM index images</name>
  <files>N/A (GitHub workflow execution)</files>
  <action>
Execute the index-render-template workflow for devel environment:

```bash
VERSION="1.15"
BRANCH="release-v${VERSION}.x"

# Trigger the workflow
gh workflow run index-render-template.yaml \
  --repo openshift-pipelines/operator \
  --ref "${BRANCH}" \
  -f environment="devel"

# Wait for workflow to start
sleep 5

# Get the run ID
RUN_ID=$(gh run list --repo openshift-pipelines/operator \
  --workflow index-render-template.yaml \
  --branch "${BRANCH}" --limit 1 \
  --json databaseId --jq '.[0].databaseId')

echo "Index workflow run ID: ${RUN_ID}"
echo "View at: https://github.com/openshift-pipelines/operator/actions/runs/${RUN_ID}"

# Watch the workflow (or check manually if this times out)
gh run watch ${RUN_ID} --repo openshift-pipelines/operator --exit-status || echo "Check workflow status manually"
```

**What this does:** Generates OLM index images for each supported OCP version (4.12, 4.14, 4.15, 4.16, 4.17, 4.18). The workflow creates PRs that update the index/catalog with the new operator bundle.

**What to avoid:** Do NOT trigger with environment="staging" or "production" — this is devel release only.
  </action>
  <verify>
```bash
# Verify workflow completed successfully
gh run list --repo openshift-pipelines/operator \
  --workflow index-render-template.yaml \
  --branch "release-v1.15.x" --limit 1 \
  --json status,conclusion
```
Output should show `{"status":"completed","conclusion":"success"}`
  </verify>
  <done>index-render-template workflow completed successfully for devel environment</done>
</task>

<task type="auto">
  <name>Task 2: Merge index PRs and wait for Konflux pipelines</name>
  <files>N/A (GitHub PR operations)</files>
  <action>
Find and merge the index PRs created by the workflow:

```bash
VERSION="1.15"
BRANCH="release-v${VERSION}.x"

# List index PRs created by the workflow
echo "=== Index PRs ==="
gh pr list --repo openshift-pipelines/operator \
  --base "${BRANCH}" --state open \
  --json number,title,url | jq '.[] | select(.title | test("catalog"; "i"))'

# Merge each index PR (use --rebase as squash/merge not allowed on this repo)
for PR in $(gh pr list --repo openshift-pipelines/operator \
  --base "${BRANCH}" --state open \
  --json number,title | jq -r '.[] | select(.title | test("catalog"; "i")) | .number'); do
  echo "Merging PR #${PR}..."
  gh pr merge ${PR} --repo openshift-pipelines/operator --rebase --admin || \
    echo "Failed to merge PR #${PR} - may need manual review"
done
```

**After merge, wait for Konflux on-push pipelines:**

The Konflux pipelines build the index images and push them to:
- `quay.io/redhat-user-workloads/tekton-ecosystem-tenant/1-15/...`

```bash
echo "=== Waiting for index pipelines ==="
sleep 30

# Check PR pipeline status
for PR in 14207 14208 14209 14210 14211 14212; do
  echo "PR #${PR}:"
  gh pr checks ${PR} --repo openshift-pipelines/operator 2>/dev/null | grep -E "Konflux|status" || echo "  No checks"
done
```

**What to avoid:** Do NOT proceed to image copy if any pipelines failed — diagnose failures first.
  </action>
  <verify>
```bash
# Verify no open index PRs remain
OPEN=$(gh pr list --repo openshift-pipelines/operator \
  --base "release-v1.15.x" --state open \
  --json title | jq '[.[] | select(.title | test("catalog"; "i"))] | length')

echo "Open index PRs: ${OPEN}"
[ "$OPEN" -eq 0 ] && echo "✅ All index PRs merged"
```
  </verify>
  <done>All index PRs merged, Konflux on-push pipelines building</done>
</task>

<task type="auto">
  <name>Task 3: Copy images from Konflux to devel registry</name>
  <files>N/A (skopeo operations)</files>
  <action>
**CRITICAL STEP:** Once Konflux pipelines are green, copy images from the build registry to the devel registry.

Per the release guide: "Once CI is green, do skopeo copy from `quay.io/redhat-user-workload` to `quay.io/openshift-pipeline`"

```bash
VERSION="1.15"
VERSION_DASH="${VERSION//./-}"  # 1-15

# Source: Konflux build registry
SRC_REGISTRY="quay.io/redhat-user-workloads/tekton-ecosystem-tenant/${VERSION_DASH}"

# Destination: Devel registry
DST_REGISTRY="quay.io/openshift-pipeline"

echo "=== Copying Index Images to Devel Registry ==="
echo "Source: ${SRC_REGISTRY}"
echo "Destination: ${DST_REGISTRY}"
echo ""

# Copy index images for each OCP version
for OCP in 4.12 4.14 4.15 4.16 4.17 4.18; do
  OCP_DASH="${OCP//./-}"  # 4-17

  echo "Copying index v${OCP}..."

  # Get the latest digest from source
  SRC_IMAGE="${SRC_REGISTRY}/operator-${VERSION_DASH}-index-${OCP_DASH}-rhel8"
  DST_IMAGE="${DST_REGISTRY}/pipelines-index-rhel8:v${OCP}"

  skopeo copy --all \
    "docker://${SRC_IMAGE}" \
    "docker://${DST_IMAGE}" && \
    echo "  ✅ Copied index v${OCP}" || \
    echo "  ❌ Failed to copy index v${OCP}"
done

# Also copy operator bundle
echo ""
echo "Copying operator bundle..."
skopeo copy --all \
  "docker://${SRC_REGISTRY}/operator-${VERSION_DASH}-bundle-rhel8" \
  "docker://${DST_REGISTRY}/pipelines-operator-bundle-rhel8" && \
  echo "  ✅ Copied operator bundle" || \
  echo "  ❌ Failed to copy operator bundle"
```

**Authentication required:** You need push access to `quay.io/openshift-pipeline`. Run `podman login quay.io` first if needed.

**What to avoid:** Do NOT copy if Konflux pipelines haven't completed successfully.
  </action>
  <verify>
```bash
# Verify images exist in devel registry
REGISTRY="quay.io/openshift-pipeline"

echo "=== Verifying Devel Registry ==="
for OCP in 4.14 4.15 4.16 4.17 4.18; do
  DIGEST=$(skopeo inspect --no-tags "docker://${REGISTRY}/pipelines-index-rhel8:v${OCP}" 2>/dev/null | jq -r '.Digest' || echo "")
  if [ -n "$DIGEST" ]; then
    echo "✅ Index v${OCP}: ${DIGEST:0:20}..."
  else
    echo "❌ Index v${OCP}: NOT FOUND"
  fi
done
```
  </verify>
  <done>All index images copied to quay.io/openshift-pipeline devel registry</done>
</task>

<task type="auto">
  <name>Task 4: Verify devel images and generate QE handoff summary</name>
  <files>N/A (verification and summary)</files>
  <action>
Final verification and QE handoff:

```bash
REGISTRY="quay.io/openshift-pipeline"
VERSION="1.15"

echo "=== Final Verification ==="
echo "Registry: ${REGISTRY}"
echo ""

# Check operator bundle
echo "Operator bundle:"
skopeo inspect --no-tags "docker://${REGISTRY}/pipelines-operator-bundle-rhel8" 2>/dev/null | \
  jq '{digest: .Digest, created: .Created}' || echo "Not found"

# Check index images for each OCP version
echo ""
echo "Index images:"
for OCP in 4.12 4.14 4.15 4.16 4.17 4.18; do
  echo ""
  echo "  Index v${OCP}:"
  skopeo inspect --no-tags "docker://${REGISTRY}/pipelines-index-rhel8:v${OCP}" 2>/dev/null | \
    jq '{digest: .Digest}' || echo "  Not found"
done
```

**Generate QE handoff summary:**

The dev release is complete. Generate a summary for QE team with:
1. Index image locations in quay.io/openshift-pipeline
2. OCP versions supported (4.12, 4.14-4.18)
3. Installation instructions using CatalogSource
4. What was fixed in 1.15.4 (CVEs: jwt-go, oauth2, x/crypto)
  </action>
  <verify>
```bash
# Quick verification that all indexes exist
COUNT=0
for OCP in 4.14 4.15 4.16 4.17 4.18; do
  FOUND=$(skopeo inspect --no-tags "docker://quay.io/openshift-pipeline/pipelines-index-rhel8:v${OCP}" 2>/dev/null | jq '.Digest' || echo "")
  [ -n "$FOUND" ] && COUNT=$((COUNT + 1))
done
echo "Verified ${COUNT}/5 index images in devel registry"
[ "$COUNT" -eq 5 ] && echo "✅ All index images verified"
```
  </verify>
  <done>All devel images verified, QE handoff summary generated with installation instructions</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] index-render-template workflow completed successfully
- [ ] All index PRs merged to release-v1.15.x
- [ ] Konflux on-push pipelines passed (no failures)
- [ ] Images copied from quay.io/redhat-user-workloads to quay.io/openshift-pipeline
- [ ] Index images available in quay.io/openshift-pipeline for OCP 4.12, 4.14-4.18
- [ ] QE handoff summary generated
</verification>

<success_criteria>

- All 4 tasks completed
- All verification checks pass
- No pipeline failures
- Images successfully copied to devel registry
- Dev release (1.15.4) ready for QE testing
- Phase 3 complete
</success_criteria>

<output>
After completion, create `.planning/phases/03-dev-release/03-01-SUMMARY.md`:

# Phase 3 Plan 1: Dev Release Summary

**[Substantive one-liner about what shipped]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]
- [Key outcome 3]

## Pipeline Results

| Workflow | Status | Run ID |
|----------|--------|--------|
| index-render-template | ✅ | {run_id} |

## Index Images

| OCP Version | Registry | Status |
|-------------|----------|--------|
| v4.14 | quay.io/openshift-pipeline | ✅ |
| v4.15 | quay.io/openshift-pipeline | ✅ |
| v4.16 | quay.io/openshift-pipeline | ✅ |
| v4.17 | quay.io/openshift-pipeline | ✅ |
| v4.18 | quay.io/openshift-pipeline | ✅ |

## QE Handoff

**Installation Instructions:**
```yaml
apiVersion: operators.coreos.com/v1alpha1
kind: CatalogSource
metadata:
  name: openshift-pipelines-dev
  namespace: openshift-marketplace
spec:
  sourceType: grpc
  image: quay.io/openshift-pipeline/pipelines-index-rhel8:v{OCP_VERSION}
  displayName: OpenShift Pipelines Dev
  publisher: Red Hat
```

**What's Fixed in 1.15.4:**
- CVE fixes: jwt-go v4.5.2, x/crypto v0.35.0, oauth2 v0.27.0
- All Konflux pipeline fixes (PAC_BUILDER, TKN_VERSION)

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

**Phase 3: Dev Release COMPLETE**

Ready for Phase 4: Stage Release
- QE validates devel images
- After QE sign-off, run `/gsd:plan-phase 4` for stage release
</output>
