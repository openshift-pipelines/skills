---
phase: 01-assessment
plan: 02
type: execute
subsystem: konflux-pipelines
tags: [assessment, konflux, pipeline-freshness, image-retention]

requires:
  - release-state-baseline (from 01-01)
provides:
  - konflux-pipeline-freshness-report
  - stale-components-list
affects: [02-fix-blockers]

tech-stack:
  added: []
  patterns: []
---

# Phase 1 Plan 2: Konflux Pipeline Freshness Assessment

<objective>
Check the age of Konflux on-push pipeline runs for all downstream components on the release-v1.15.x branch. Images built by Konflux are cleaned up after 72 hours, so any component with a build older than this threshold needs re-triggering before release execution.
</objective>

<context>
**Why this matters:**
- Konflux images in `quay.io/redhat-user-workloads/tekton-ecosystem-tenant/` have a retention policy
- Images older than ~72 hours get garbage collected
- If we proceed to release without fresh images, the release pipelines will fail with "image not found"
- This assessment identifies which components need their on-push pipelines re-triggered in Phase 2

**Components to check (14 total):**

| Component | Repository | Branch |
|-----------|------------|--------|
| pipeline | openshift-pipelines/tektoncd-pipeline | release-v1.15.x |
| triggers | openshift-pipelines/tektoncd-triggers | release-v1.15.x |
| chains | openshift-pipelines/tektoncd-chains | release-v1.15.x |
| results | openshift-pipelines/tektoncd-results | release-v1.15.x |
| hub | openshift-pipelines/tektoncd-hub | release-v1.15.x |
| pac | openshift-pipelines/pac-downstream | release-v1.15.x |
| cli | openshift-pipelines/tektoncd-cli | release-v1.15.x |
| git-init | openshift-pipelines/tektoncd-git-clone | release-v1.15.x |
| operator | openshift-pipelines/operator | release-v1.15.x |
| console-plugin | openshift-pipelines/console-plugin | release-v1.15.x |
| manual-approval-gate | openshift-pipelines/manual-approval-gate | release-v0.X.X (check hack config) |
| opc | openshift-pipelines/opc | release-v1.15.x |
| caches | openshift-pipelines/tekton-caches | release-v0.X.X (check hack config) |
| pruner | openshift-pipelines/tektoncd-pruner | release-v0.X.X (check hack config) |

**Note:** MAG, Caches, and Pruner have component-specific version branches. Must check hack repo config for exact branch names.
</context>

<tasks>

## Task 1: Get exact branch names from hack config

Clone hack repo to get the precise branch names for all components:

```bash
MINOR_VERSION="1.15"
HACK_BRANCH="release-v${MINOR_VERSION}.x"

# Clone hack repo
git clone https://github.com/openshift-pipelines/hack -b "${HACK_BRANCH}" --depth=1 /tmp/hack-${MINOR_VERSION} 2>/dev/null || echo "Using existing clone"

# Extract branch mappings for all components
echo "=== Component Branch Mappings for 1.15.x ==="
for config in /tmp/hack-${MINOR_VERSION}/config/konflux/repos/*.yaml; do
  REPO_NAME=$(yq -r '.name' "$config" 2>/dev/null || grep "^name:" "$config" | cut -d: -f2 | tr -d ' ')
  BRANCH_NAME=$(yq -r '.branches[0].name' "$config" 2>/dev/null || grep -A1 "branches:" "$config" | tail -1 | grep "name:" | cut -d: -f2 | tr -d ' ')
  echo "$REPO_NAME: $BRANCH_NAME"
done
```

## Task 2: Check pipeline freshness for each component

For each component, get the most recent workflow run or commit on the release branch:

```bash
THRESHOLD_HOURS=72
NOW_EPOCH=$(date +%s)

# Function to check component freshness
check_component() {
  local REPO="$1"
  local BRANCH="$2"
  local FULL_REPO="openshift-pipelines/${REPO}"

  # Get last commit date on the branch
  LAST_COMMIT=$(gh api "repos/${FULL_REPO}/branches/${BRANCH}" --jq '.commit.commit.committer.date' 2>/dev/null)

  if [ -z "$LAST_COMMIT" ] || [ "$LAST_COMMIT" = "null" ]; then
    echo "${REPO}|${BRANCH}|BRANCH_NOT_FOUND|N/A|NEEDS_CHECK"
    return
  fi

  # Convert to epoch
  COMMIT_EPOCH=$(date -j -f "%Y-%m-%dT%H:%M:%SZ" "$LAST_COMMIT" +%s 2>/dev/null || date -d "$LAST_COMMIT" +%s)
  AGE_HOURS=$(( (NOW_EPOCH - COMMIT_EPOCH) / 3600 ))

  # Determine status
  if [ "$AGE_HOURS" -gt "$THRESHOLD_HOURS" ]; then
    STATUS="STALE (${AGE_HOURS}h > ${THRESHOLD_HOURS}h)"
    NEEDS_TRIGGER="YES"
  else
    STATUS="FRESH (${AGE_HOURS}h)"
    NEEDS_TRIGGER="NO"
  fi

  echo "${REPO}|${BRANCH}|${LAST_COMMIT}|${AGE_HOURS}h|${NEEDS_TRIGGER}"
}

# Check all components
echo "Component|Branch|Last Commit|Age|Needs Trigger"
echo "---------|------|-----------|---|-------------"

# Standard branch components
for REPO in tektoncd-pipeline tektoncd-triggers tektoncd-chains tektoncd-results tektoncd-hub pac-downstream tektoncd-cli tektoncd-git-clone operator console-plugin opc; do
  check_component "$REPO" "release-v1.15.x"
done

# Custom branch components (get from hack config)
# These need their specific branches from Task 1
```

## Task 3: Compile stale components list

Create a summary of components that need on-push pipelines re-triggered:

```markdown
## Konflux Pipeline Freshness Report

**Assessment Date:** {date}
**Threshold:** 72 hours
**Release Branch:** release-v1.15.x

### Summary

| Status | Count |
|--------|-------|
| Fresh (< 72h) | X |
| Stale (> 72h) | Y |
| Branch Not Found | Z |

### Component Status

| Component | Branch | Last Activity | Age | Status |
|-----------|--------|---------------|-----|--------|
| tektoncd-pipeline | release-v1.15.x | 2026-01-17 | 48h | FRESH |
| tektoncd-cli | release-v1.15.x | 2026-01-15 | 96h | STALE |
| ... | ... | ... | ... | ... |

### Components Needing Re-trigger (Phase 2 Action Items)

1. **tektoncd-cli** - Last build 96h ago
   - Repo: https://github.com/openshift-pipelines/tektoncd-cli
   - Action: Trigger empty commit or workflow dispatch on release-v1.15.x

2. **{component}** - Last build Xh ago
   - Repo: https://github.com/openshift-pipelines/{component}
   - Action: {specific action}
```

## Task 4: Update Phase 2 scope

Add stale component re-triggering to Phase 2 Fix Blockers scope:

For each stale component, the fix is:
1. **Option A: Empty commit** - Push an empty commit to trigger on-push pipeline
   ```bash
   git commit --allow-empty -m "chore: trigger Konflux rebuild for 1.15.4 release"
   git push
   ```

2. **Option B: Workflow dispatch** - If the repo has a re-trigger workflow
   ```bash
   gh workflow run <workflow>.yaml --repo openshift-pipelines/<component> --ref release-v1.15.x
   ```

3. **Option C: Konflux UI** - Manually trigger build from Konflux console

</tasks>

<success_criteria>
- [ ] All 14 component branch names resolved from hack config
- [ ] Last activity date retrieved for each component on release branch
- [ ] Age calculated and compared to 72h threshold
- [ ] Stale components list generated with specific action items
- [ ] Phase 2 scope updated with re-trigger tasks
- [ ] No component left unchecked
</success_criteria>

<output>
A comprehensive Konflux pipeline freshness report containing:
1. Complete component/branch mapping for 1.15.x
2. Last activity date and age for each component
3. Clear identification of stale (> 72h) vs fresh (< 72h) components
4. Action items for Phase 2 to re-trigger stale builds
</output>
