---
phase: 03-dev-release
plan: 02
type: execute
---

<objective>
Release OpenShift Pipelines 1.15.4 properly — update versions, rebuild all images, and verify deployment.

Purpose: The v1.15.3 bundle has old image digests. For a proper 1.15.4 release, we need to:
1. Update version strings to 1.15.4
2. Trigger fresh component builds
3. Update operator bundle with new component images
4. Build fresh index images
5. Copy to dev registry and test

Output: Working 1.15.4 deployment on test cluster with correct version strings.
</objective>

<context>
@.planning/phases/03-dev-release/03-01-SUMMARY.md

**Problem discovered:**
- Bundle CSV references `registry.redhat.io/openshift-pipelines/` with OLD digests
- Those digests are from v1.15.3 builds, not the new CVE-fixed builds
- Version strings show 1.15.3, not 1.15.4
- Simply copying images won't work — need proper version update

**Release workflow:**
1. Update `project.yaml` version to 1.15.4
2. Run `update-sources` workflow to sync upstream changes
3. Run `operator-update-images` to update bundle with fresh component SHAs
4. Run `index-render-template` to create new index images
5. Copy all images (components + bundle + index) to dev registry
6. Test deployment

**Repositories:**
- Operator: https://github.com/openshift-pipelines/operator (branch: release-v1.15)
- Hack: https://github.com/openshift-pipelines/hack (branch: release-v0.37.2)

**Test Cluster:** OCP 4.18.30 (api.e8yd8-jboom-ft5.xazm.p3.openshiftapps.com)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update operator project.yaml to 1.15.4</name>
  <files>project.yaml in openshift-pipelines/operator</files>
  <action>
Update `project.yaml` on the `release-v1.15` branch:

```bash
# Clone operator repo
WORK_DIR="/tmp/operator-1.15.4"
rm -rf "${WORK_DIR}"
git clone https://github.com/openshift-pipelines/operator -b release-v1.15 "${WORK_DIR}"
cd "${WORK_DIR}"

# Check current version
cat project.yaml | grep -A5 "version:"

# Update version from 1.15.3 to 1.15.4
# - current: "1.15.4"
# - previous: "1.15.3"
```

Create PR with version update.
  </action>
  <verify>project.yaml shows version.current: "1.15.4"</verify>
  <done>Version updated to 1.15.4 in project.yaml</done>
</task>

<task type="auto">
  <name>Task 2: Run update-sources workflow</name>
  <files>N/A (GitHub Actions)</files>
  <action>
Trigger the update-sources workflow to sync any upstream changes:

```bash
# Trigger update-sources workflow
gh workflow run "update-sources-release-v1.15.yaml" \
  --repo "openshift-pipelines/operator" \
  --ref main

# Wait and get run ID
sleep 10
gh run list --repo "openshift-pipelines/operator" \
  --workflow "update-sources-release-v1.15.yaml" \
  --limit 1

# Watch the run
gh run watch <RUN_ID> --repo openshift-pipelines/operator
```

Wait for completion and merge bot PR if created.
  </action>
  <verify>Workflow completed successfully, bot PR merged</verify>
  <done>update-sources workflow complete</done>
</task>

<task type="auto">
  <name>Task 3: Run operator-update-images workflow</name>
  <files>N/A (GitHub Actions)</files>
  <action>
Trigger operator-update-images to update the bundle with fresh component image SHAs:

```bash
# Trigger operator-update-images workflow
gh workflow run "operator-update-images-release-v1.15.yaml" \
  --repo "openshift-pipelines/operator" \
  --ref main

# Watch the run
sleep 10
RUN_ID=$(gh run list --repo "openshift-pipelines/operator" \
  --workflow "operator-update-images-release-v1.15.yaml" \
  --limit 1 --json databaseId --jq '.[0].databaseId')
gh run watch ${RUN_ID} --repo openshift-pipelines/operator
```

This creates a PR that updates:
- Component image SHAs in the operator config
- Bundle references to use fresh component images

Merge the PR and wait for Konflux to build new bundle.
  </action>
  <verify>
```bash
# Check for PR from workflow
gh pr list --repo "openshift-pipelines/operator" --base "release-v1.15" --state open

# After merge, verify Konflux build
# Check: https://console.redhat.com/application-pipeline/workspaces/tekton-ecosystem-tenant
```
  </verify>
  <done>Operator bundle updated with fresh component images</done>
</task>

<task type="auto">
  <name>Task 4: Run index-render-template workflow</name>
  <files>N/A (GitHub Actions)</files>
  <action>
After the new bundle is built, run index-render-template to create fresh index images:

```bash
# Trigger index-render-template workflow
gh workflow run "index-render-template" \
  --repo "openshift-pipelines/operator" \
  --ref "release-v1.15" \
  -f version="1.15"

# Watch the run
sleep 10
gh run list --repo "openshift-pipelines/operator" \
  --workflow "index-render-template" \
  --limit 1
```

This creates PRs for each OCP version (4.14, 4.15, 4.16, 4.17, 4.18).
Merge all PRs and wait for Konflux to build index images.
  </action>
  <verify>
```bash
# Check for catalog PRs
gh pr list --repo "openshift-pipelines/operator" --base "release-v1.15" | grep -i catalog

# After merge, check Konflux for index builds
```
  </verify>
  <done>Index images built with new bundle</done>
</task>

<task type="auto">
  <name>Task 5: Copy all images to dev registry</name>
  <files>N/A</files>
  <action>
After all builds complete, copy images to quay.io/openshift-pipeline:

1. Get fresh image references from Konflux Snapshots API
2. Copy all component images
3. Copy bundle image
4. Copy index images

```bash
# Use /osp:konflux-image skill with batch mode to get all images
# Then copy each to quay.io/openshift-pipeline

# For index images:
for ocp in 4.14 4.15 4.16 4.17 4.18; do
  # Get index image from Konflux
  # Copy to quay.io/openshift-pipeline/pipelines-index-${ocp}:1.15
done
```
  </action>
  <verify>
```bash
# Verify index images exist
for ocp in 4.14 4.15 4.16 4.17 4.18; do
  skopeo inspect docker://quay.io/openshift-pipeline/pipelines-index-${ocp}:1.15 2>/dev/null && echo "${ocp}: OK" || echo "${ocp}: MISSING"
done
```
  </verify>
  <done>All images copied to dev registry</done>
</task>

<task type="auto">
  <name>Task 6: Test deployment on cluster</name>
  <files>N/A</files>
  <action>
Delete the existing operator and reinstall from fresh index:

```bash
# Delete existing subscription and CSV
oc delete subscription openshift-pipelines-operator -n openshift-operators 2>/dev/null
oc delete csv -n openshift-operators -l operators.coreos.com/openshift-pipelines-operator-rh.openshift-operators

# Delete CatalogSource
oc delete catalogsource openshift-pipelines-dev -n openshift-marketplace

# Wait for cleanup
sleep 30

# Create fresh CatalogSource
oc apply -f - <<EOF
apiVersion: operators.coreos.com/v1alpha1
kind: CatalogSource
metadata:
  name: openshift-pipelines-dev
  namespace: openshift-marketplace
spec:
  sourceType: grpc
  image: quay.io/openshift-pipeline/pipelines-index-4.18:1.15
  displayName: OpenShift Pipelines 1.15.4 Dev
  publisher: Red Hat
EOF

# Wait for catalog to be ready
sleep 60

# Create subscription
oc apply -f - <<EOF
apiVersion: operators.coreos.com/v1alpha1
kind: Subscription
metadata:
  name: openshift-pipelines-operator
  namespace: openshift-operators
spec:
  channel: pipelines-1.15
  name: openshift-pipelines-operator-rh
  source: openshift-pipelines-dev
  sourceNamespace: openshift-marketplace
  installPlanApproval: Automatic
EOF
```
  </action>
  <verify>
```bash
# Check version shows 1.15.4
oc get tektonconfig config -o jsonpath='{.status.version}'

# Check all pods running
oc get pods -n openshift-pipelines | grep -v Running | grep -v Completed

# TektonConfig should be Ready
oc get tektonconfig config -o jsonpath='{.status.conditions[?(@.type=="Ready")].status}'
```
  </verify>
  <done>1.15.4 deployed and verified</done>
</task>

<task type="auto">
  <name>Task 7: Generate QE handoff</name>
  <files>.planning/phases/03-dev-release/QE-HANDOFF.md</files>
  <action>
Create QE handoff document with:
- Index image locations
- Installation instructions
- What's fixed in 1.15.4 (CVEs)
- Version verification steps
  </action>
  <verify>QE handoff document exists with all required info</verify>
  <done>QE handoff complete</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] project.yaml shows version 1.15.4
- [ ] All component images rebuilt with version 1.15.4
- [ ] Bundle references new component images
- [ ] Index images contain new bundle
- [ ] All images copied to quay.io/openshift-pipeline
- [ ] Test cluster shows version 1.15.4
- [ ] All pods running without ImagePullBackOff
- [ ] Basic TaskRun works
</verification>

<success_criteria>
- Version string shows 1.15.4 (not 1.15.3)
- All CVE fixes included in deployed images
- Operator fully functional on test cluster
- QE can install using provided index images
</success_criteria>

<commit_guidance>
type: docs
scope: 03-02
message: "complete 1.15.4 dev release with version update"
</commit_guidance>
