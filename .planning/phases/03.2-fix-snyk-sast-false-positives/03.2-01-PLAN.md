---
phase: 03.2-fix-snyk-sast-false-positives
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: []
autonomous: true

must_haves:
  truths:
    - "All 15-16 Snyk SAST false positives are identified with exact file paths and line numbers"
    - "We know whether #nosec G101 comments work with Snyk Code in Konflux"
    - "If #nosec works, we have a clear list of lines needing annotations"
    - "If #nosec doesn't work, we have a documented fallback approach"
  artifacts:
    - path: ".planning/phases/03.2-fix-snyk-sast-false-positives/SNYK-FINDINGS.md"
      provides: "Exact file paths, line numbers, and strings flagged by Snyk"
    - path: ".planning/phases/03.2-fix-snyk-sast-false-positives/APPROACH-DECISION.md"
      provides: "Decision on which approach to use based on test results"
  key_links:
    - from: "Konflux EC failure logs"
      to: "SNYK-FINDINGS.md"
      via: "Parse snyk-code-test results from pipeline logs"
      pattern: "sast-snyk-check.*results"
---

<objective>
Locate all Snyk SAST false positives in operator/proxy/webhook code and test whether #nosec G101 comments suppress them in Konflux pipelines.

Purpose: Before implementing a fix, we need to know (1) exactly which lines are flagged and (2) whether the recommended #nosec approach actually works with Snyk Code in Konflux.

Output: SNYK-FINDINGS.md documenting all false positives, APPROACH-DECISION.md confirming the fix strategy.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/ISSUES.md
@.planning/phases/03.2-fix-snyk-sast-false-positives/03.2-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract Snyk findings from Konflux pipeline logs</name>
  <files>.planning/phases/03.2-fix-snyk-sast-false-positives/SNYK-FINDINGS.md</files>
  <action>
Find the sast-snyk-check task results from recent operator/proxy/webhook PR pipeline runs:

1. Get recent PR numbers from operator repo (PRs #14352, #14353, #14354, #14355 mentioned in STATE.md)
2. Access Konflux console (https://console.redhat.com/application-pipeline) or use Konflux API
3. Find the sast-snyk-check task logs for one of these PRs
4. Parse the Snyk Code JSON results to extract:
   - Rule ID (should be similar to G101 / CWE-798)
   - File path (relative to repo root)
   - Line number
   - Code snippet flagged
   - Message describing the finding

Document all 15-16 findings in SNYK-FINDINGS.md with format:

```markdown
# Snyk SAST False Positives - Operator

## Summary
- Total findings: {N}
- Rule: {rule ID}
- Type: Hardcoded credentials (false positive)

## Findings

### Finding 1
- **File:** pkg/reconciler/openshift/tektonresult/xxx.go
- **Line:** 42
- **Code:** `const TektonResultsPostgresSecret = "tekton-results-postgres"`
- **Message:** Hardcoded credentials detected
- **False positive reason:** Kubernetes Secret resource name, not actual credential

[Repeat for all findings]
```

If Konflux console requires SSO that Claude cannot access, use the workaround:
- Check if any recent PR has EC failure details visible in GitHub PR checks
- Use `gh pr view {PR} --json statusCheckRollup` to get check details
- Look for snyk-code-test or sast-snyk-check in the results
  </action>
  <verify>SNYK-FINDINGS.md exists with at least 15 documented false positives including file paths and line numbers</verify>
  <done>All 15-16 Snyk SAST false positives documented with exact locations</done>
</task>

<task type="auto">
  <name>Task 2: Test #nosec suppression approach</name>
  <files>.planning/phases/03.2-fix-snyk-sast-false-positives/APPROACH-DECISION.md</files>
  <action>
Test whether #nosec G101 comments work with Snyk Code in Konflux:

**Option A - Local Test (preferred if operator repo is cloned):**
1. Clone github.com/openshift/tektoncd-operator if not present
2. Find one of the flagged files from SNYK-FINDINGS.md
3. Add `// #nosec G101 -- Kubernetes Secret resource name, not credential` to one flagged line
4. Create a test branch and PR to trigger Konflux pipeline
5. Check sast-snyk-check results - does the annotated finding disappear?

**Option B - Research Verification (if cannot trigger pipeline):**
1. Search for existing PRs in tektoncd-operator that use #nosec comments
2. Check if those PRs passed sast-snyk-check without those specific findings
3. Search Konflux/Snyk documentation for confirmation of #nosec support
4. Make educated decision based on:
   - Snyk Code is based on Gosec patterns
   - Gosec definitively supports #nosec
   - Risk: Snyk may use different parser

**Option C - Fallback Approach (if #nosec doesn't work):**
1. Document that #nosec does NOT work with Snyk Code in Konflux
2. Identify alternative: Snyk Web UI ignores (requires org access)
3. Identify alternative: IGNORE_FILE_PATHS (too broad, but works)
4. Escalate to get Snyk org access or accept temporary IGNORE_FILE_PATHS

Create APPROACH-DECISION.md with:

```markdown
# Phase 3.2 Approach Decision

## Test Result
- **#nosec G101 works with Snyk Code:** YES / NO / UNTESTED
- **Evidence:** [link to PR, pipeline logs, or documentation]

## Recommended Approach
[Based on test results]

## Implementation Plan
[Specific steps for Plan 03.2-02]

## Risks
[Any remaining uncertainties]
```
  </action>
  <verify>APPROACH-DECISION.md exists with clear YES/NO decision on #nosec approach</verify>
  <done>We know definitively whether #nosec works and have a clear implementation path for Plan 02</done>
</task>

</tasks>

<verification>
After completing both tasks:
1. SNYK-FINDINGS.md documents all false positives with file:line precision
2. APPROACH-DECISION.md confirms whether #nosec works
3. We have a clear path forward for implementing the fix
</verification>

<success_criteria>
- All 15-16 Snyk SAST false positives identified with exact file paths and line numbers
- Clear YES/NO answer on whether #nosec G101 comments work with Snyk Code
- If YES: List of exact lines needing #nosec annotations ready for Plan 02
- If NO: Alternative approach documented (Snyk Web UI or IGNORE_FILE_PATHS)
</success_criteria>

<output>
After completion, create `.planning/phases/03.2-fix-snyk-sast-false-positives/03.2-01-SUMMARY.md`
</output>
