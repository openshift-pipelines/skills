---
phase: 03-dev-release
plan: 01
type: execute
---

<objective>
Execute development release for OpenShift Pipelines 1.15.4 — generate INDEX images and verify readiness for QE testing.

Purpose: Complete the devel release pipeline (CORE → CLI → OPERATOR → **INDEX**) so QE can test the 1.15.4 patch before stage release.
Output: All index images built and available in quay.io/openshift-pipeline, ready for QE installation testing.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-fix-blockers/02-04-SUMMARY.md

**Prior Phase Context (02-04):**
- All 11 component images verified fresh (<72h)
- Operator bundle updated with fresh images (PR #14206 merged)
- Release build order: CORE → CLI → OPERATOR → INDEX
- Phase 2 completed operator update; INDEX is the remaining step

**Release Order (Critical):**
1. ~~CORE~~ — Pipeline, Triggers, Chains, Results, Hub, PAC, git-clone, console-plugin, MAG (DONE)
2. ~~CLI~~ — tektoncd-cli (DONE)
3. ~~OPERATOR~~ — Operator bundle updated (DONE via PR #14206)
4. **INDEX** — OLM index images for each OCP version (THIS PHASE)

**Target Registry:** `quay.io/openshift-pipeline` (devel environment)

**Skills Available:**
- `/osp:operator-release` — Runs index-render-template workflow
- `/osp:component-builds` — Verifies pipeline status

**Version Info:**
- Release: 1.15.4
- Branch: release-v1.15.x
- Minor: 1.15
</context>

<tasks>

<task type="auto">
  <name>Task 1: Run index-render-template workflow to generate OLM index images</name>
  <files>N/A (GitHub workflow execution)</files>
  <action>
Execute the index-render-template workflow for devel environment:

```bash
VERSION="1.15"
BRANCH="release-v${VERSION}.x"

# Trigger the workflow
gh workflow run index-render-template.yaml \
  --repo openshift-pipelines/operator \
  --ref "${BRANCH}" \
  -f environment="devel"

# Wait for workflow to start
sleep 5

# Get the run ID
RUN_ID=$(gh run list --repo openshift-pipelines/operator \
  --workflow index-render-template.yaml \
  --branch "${BRANCH}" --limit 1 \
  --json databaseId --jq '.[0].databaseId')

echo "Index workflow run ID: ${RUN_ID}"
echo "View at: https://github.com/openshift-pipelines/operator/actions/runs/${RUN_ID}"

# Watch the workflow (or check manually if this times out)
gh run watch ${RUN_ID} --repo openshift-pipelines/operator --exit-status || echo "Check workflow status manually"
```

**What this does:** Generates OLM index images for each supported OCP version (4.14, 4.15, 4.16, 4.17, 4.18). The workflow creates PRs that update the index/catalog with the new operator bundle.

**What to avoid:** Do NOT trigger with environment="staging" or "production" — this is devel release only.
  </action>
  <verify>
```bash
# Verify workflow completed successfully
gh run list --repo openshift-pipelines/operator \
  --workflow index-render-template.yaml \
  --branch "release-v1.15.x" --limit 1 \
  --json status,conclusion
```
Output should show `{"status":"completed","conclusion":"success"}`
  </verify>
  <done>index-render-template workflow completed successfully for devel environment</done>
</task>

<task type="auto">
  <name>Task 2: Merge index PRs and verify index pipelines pass</name>
  <files>N/A (GitHub PR operations)</files>
  <action>
Find and merge the index PRs created by the workflow:

```bash
VERSION="1.15"
BRANCH="release-v${VERSION}.x"

# List index PRs created by the workflow
echo "=== Index PRs ==="
gh pr list --repo openshift-pipelines/operator \
  --base "${BRANCH}" --state open \
  --json number,title,url | jq '.[] | select(.title | test("index|catalog|fbc"; "i"))'

# Merge each index PR
for PR in $(gh pr list --repo openshift-pipelines/operator \
  --base "${BRANCH}" --state open \
  --json number,title | jq -r '.[] | select(.title | test("index|catalog|fbc"; "i")) | .number'); do
  echo "Merging PR #${PR}..."
  gh pr merge ${PR} --repo openshift-pipelines/operator --squash --admin || \
    echo "Failed to merge PR #${PR} - may need manual review"
done
```

**After merge, wait for Konflux on-push pipelines:**

```bash
echo "=== Waiting for index pipelines ==="
sleep 30

# Check pipeline status for operator repo (includes index builds)
echo "Checking pipeline status..."
gh run list --repo openshift-pipelines/operator \
  --branch "${BRANCH}" --limit 10 \
  --json name,status,conclusion,createdAt | \
  jq '.[] | select(.name | test("push|build"; "i"))'

# Wait for in-progress builds to complete (poll for up to 30 min)
MAX_WAIT=1800
ELAPSED=0
INTERVAL=60

while [ $ELAPSED -lt $MAX_WAIT ]; do
  IN_PROGRESS=$(gh run list --repo openshift-pipelines/operator \
    --branch "${BRANCH}" --status in_progress \
    --json databaseId | jq 'length')

  if [ "$IN_PROGRESS" -eq 0 ]; then
    echo "All pipelines completed!"
    break
  fi

  echo "  ${IN_PROGRESS} pipeline(s) still running... (${ELAPSED}s elapsed)"
  sleep $INTERVAL
  ELAPSED=$((ELAPSED + INTERVAL))
done

# Final status check
echo ""
echo "=== Final Pipeline Status ==="
gh run list --repo openshift-pipelines/operator \
  --branch "${BRANCH}" --limit 5 \
  --json name,conclusion | jq '.[] | select(.conclusion)'
```

**What to avoid:** Do NOT proceed to verification if any pipelines failed — diagnose failures first using `/osp:pr-pipeline-status`.
  </action>
  <verify>
```bash
# Verify no open index PRs remain
OPEN=$(gh pr list --repo openshift-pipelines/operator \
  --base "release-v1.15.x" --state open \
  --json title | jq '[.[] | select(.title | test("index|catalog|fbc"; "i"))] | length')

# Verify no failed pipelines
FAILED=$(gh run list --repo openshift-pipelines/operator \
  --branch "release-v1.15.x" --limit 5 \
  --json conclusion | jq '[.[] | select(.conclusion == "failure")] | length')

echo "Open index PRs: ${OPEN}"
echo "Failed pipelines: ${FAILED}"
[ "$OPEN" -eq 0 ] && [ "$FAILED" -eq 0 ] && echo "✅ All index PRs merged, pipelines passing"
```
  </verify>
  <done>All index PRs merged, Konflux on-push pipelines passed, no failures</done>
</task>

<task type="auto">
  <name>Task 3: Verify devel images and generate QE handoff summary</name>
  <files>N/A (verification and summary)</files>
  <action>
Verify index images are available in devel registry:

```bash
REGISTRY="quay.io/openshift-pipeline"
VERSION="1.15"

echo "=== Verifying Devel Images ==="
echo "Registry: ${REGISTRY}"
echo ""

# Check operator bundle
echo "Operator bundle:"
skopeo inspect --no-tags "docker://${REGISTRY}/pipelines-operator-bundle-rhel8" 2>/dev/null | \
  jq '{digest: .Digest, created: .Created}' || echo "Not found or auth required"

# Check index images for each OCP version
echo ""
echo "Index images:"
for OCP in 4.14 4.15 4.16 4.17 4.18; do
  echo ""
  echo "  Index v${OCP}:"
  skopeo inspect --no-tags "docker://${REGISTRY}/pipelines-index-rhel8:v${OCP}" 2>/dev/null | \
    jq '{digest: .Digest}' || echo "  Not found"
done
```

**Generate QE handoff summary:**

The dev release is complete. Generate a summary for QE team with:
1. Index image locations in quay.io/openshift-pipeline
2. OCP versions supported (4.14-4.18)
3. Installation instructions using CatalogSource
4. What was fixed in 1.15.4 (CVEs: jwt-go, oauth2, x/crypto)

**What to avoid:** Do NOT notify QE if any images are missing — verify all indexes exist first.
  </action>
  <verify>
```bash
# Quick verification that at least one index exists
FOUND=$(skopeo inspect --no-tags "docker://quay.io/openshift-pipeline/pipelines-index-rhel8:v4.17" 2>/dev/null | jq '.Digest' || echo "")
[ -n "$FOUND" ] && echo "✅ Index images verified in devel registry"
```
  </verify>
  <done>All devel images verified, QE handoff summary generated with installation instructions</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] index-render-template workflow completed successfully
- [ ] All index PRs merged to release-v1.15.x
- [ ] Konflux on-push pipelines passed (no failures)
- [ ] Index images available in quay.io/openshift-pipeline for OCP 4.14-4.18
- [ ] QE handoff summary generated
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No pipeline failures
- Dev release (1.15.4) ready for QE testing
- Phase 3 complete
</success_criteria>

<output>
After completion, create `.planning/phases/03-dev-release/03-01-SUMMARY.md`:

# Phase 3 Plan 1: Dev Release Summary

**[Substantive one-liner about what shipped]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]
- [Key outcome 3]

## Pipeline Results

| Workflow | Status | Run ID |
|----------|--------|--------|
| index-render-template | ✅ | {run_id} |

## Index Images

| OCP Version | Registry | Status |
|-------------|----------|--------|
| v4.14 | quay.io/openshift-pipeline | ✅ |
| v4.15 | quay.io/openshift-pipeline | ✅ |
| v4.16 | quay.io/openshift-pipeline | ✅ |
| v4.17 | quay.io/openshift-pipeline | ✅ |
| v4.18 | quay.io/openshift-pipeline | ✅ |

## QE Handoff

**Installation Instructions:**
```yaml
apiVersion: operators.coreos.com/v1alpha1
kind: CatalogSource
metadata:
  name: openshift-pipelines-dev
  namespace: openshift-marketplace
spec:
  sourceType: grpc
  image: quay.io/openshift-pipeline/pipelines-index-rhel8:v{OCP_VERSION}
  displayName: OpenShift Pipelines Dev
  publisher: Red Hat
```

**What's Fixed in 1.15.4:**
- CVE fixes: jwt-go v4.5.2, x/crypto v0.35.0, oauth2 v0.27.0
- All Konflux pipeline fixes (PAC_BUILDER, TKN_VERSION)

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

**Phase 3: Dev Release COMPLETE**

Ready for Phase 4: Stage Release
- QE validates devel images
- After QE sign-off, run `/gsd:plan-phase 4` for stage release
</output>
