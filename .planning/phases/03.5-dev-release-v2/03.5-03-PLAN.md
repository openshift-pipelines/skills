---
phase: 03.5-dev-release-v2
plan: 03
type: execute
wave: 2
depends_on:
  - "03.5-01"
  - "03.5-02"
files_modified:
  - .planning/phases/03-dev-release/QE-HANDOFF.md
autonomous: false

must_haves:
  truths:
    - "Fresh images copied to quay.io/openshift-pipeline dev registry"
    - "QE-HANDOFF.md updated with v2 section showing new SHAs"
    - "QE can install 1.15.4 from dev registry index"
  artifacts:
    - path: ".planning/phases/03-dev-release/QE-HANDOFF.md"
      provides: "QE handoff document with v2 images"
      contains: "## v2 Images"
    - path: "quay.io/openshift-pipeline/pipelines-pipeline-nop-rhel8"
      provides: "FIPS-compliant nop image"
      contains: "new SHA with FIPS fix"
  key_links:
    - from: "operator-update-images workflow"
      to: "operator bundle CSV"
      via: "make ENVIRONMENT=devel update-reference"
      pattern: "workflow -> PR -> merge -> bundle updated"
    - from: "Konflux registry"
      to: "Dev registry"
      via: "skopeo copy --all"
      pattern: "multi-arch image copy"
---

<objective>
Trigger operator-update-images workflow, copy fresh images to dev registry, and update QE handoff document.

Purpose: With CPE label fixes (03.5-01) and FIPS nop rebuild (03.5-02) complete, we can now propagate all changes to the dev registry and notify QE of the fresh images.

Output: Fresh images in quay.io/openshift-pipeline, updated QE-HANDOFF.md with v2 section.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.5-dev-release-v2/03.5-RESEARCH.md
@.planning/phases/03.5-dev-release-v2/03.5-01-SUMMARY.md
@.planning/phases/03.5-dev-release-v2/03.5-02-SUMMARY.md
@.planning/phases/03-dev-release/QE-HANDOFF.md
@.planning/phases/03.2-fix-missing-dev-images/COPY-LOG.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Trigger operator-update-images workflow</name>
  <files></files>
  <action>
    Trigger the operator-update-images workflow in openshift-pipelines/operator repo to update bundle image references.

    **Workflow trigger:**
    ```bash
    gh workflow run operator-update-images.yaml \
      --repo openshift-pipelines/operator \
      --ref release-v1.15.x \
      -f environment=devel
    ```

    **Wait for workflow:**
    ```bash
    # Watch for workflow run to appear and complete
    gh run list --repo openshift-pipelines/operator --workflow operator-update-images.yaml --limit 5
    ```

    **What the workflow does:**
    1. Runs `make ENVIRONMENT=devel update-reference`
    2. Reads latest SHAs from project.yaml (including new nop SHA from Konflux nudge)
    3. Converts Konflux registry paths to dev registry paths
    4. Creates PR with updated CSV manifests

    **Merge the PR:**
    Once workflow creates a PR:
    1. Wait for Konflux PR pipeline to pass
    2. Merge the PR
    3. This triggers operator on-push build

    **Wait for operator on-push:**
    After PR merge, wait for operator on-push Konflux pipeline to complete. This rebuilds the bundle with new image references.
  </action>
  <verify>
    - Workflow completed successfully
    - PR created and merged
    - Operator on-push pipeline triggered
    - `gh run view --repo openshift-pipelines/operator [RUN_ID]` shows success
  </verify>
  <done>
    operator-update-images workflow complete, PR merged, operator bundle rebuilding
  </done>
</task>

<task type="auto">
  <name>Task 2: Copy changed images to dev registry</name>
  <files></files>
  <action>
    Copy the updated images from Konflux registry to dev registry.

    **Images to copy (minimum - those that changed):**
    1. `pipelines-pipeline-nop-rhel8` - FIPS fix
    2. `pipelines-pipelines-as-code-controller-rhel8` - CPE label
    3. `pipelines-pipelines-as-code-watcher-rhel8` - CPE label
    4. `pipelines-pipelines-as-code-cli-rhel8` - CPE label
    5. `pipelines-manual-approval-gate-controller-rhel8` - CPE label
    6. `pipelines-manual-approval-gate-webhook-rhel8` - CPE label
    7. `pipelines-operator-bundle-rhel8` - Bundle with updated refs

    **Copy command pattern:**
    ```bash
    skopeo copy --all \
      docker://quay.io/redhat-user-workloads/tekton-ecosystem-tenant/1-15/{image}@sha256:{digest} \
      docker://quay.io/openshift-pipeline/{image}:v1.15.4
    ```

    **Get SHAs from Konflux Snapshots API or project.yaml:**
    ```bash
    gh api repos/openshift-pipelines/operator/contents/project.yaml?ref=release-v1.15.x | jq -r '.content' | base64 -d
    ```

    **Copy all 7 images with --all flag for multi-arch support.**

    If any copy fails due to auth, authenticate to Konflux:
    ```bash
    skopeo login quay.io/redhat-user-workloads
    ```

    **Optional:** If incremental approach shows issues, fall back to copying all 31 images from Phase 3 list.
  </action>
  <verify>
    - All images accessible in quay.io/openshift-pipeline
    - SHAs match Konflux source
    - Multi-arch manifests preserved (4 architectures)
    ```bash
    skopeo inspect docker://quay.io/openshift-pipeline/pipelines-pipeline-nop-rhel8:v1.15.4 | jq '.Digest'
    ```
  </verify>
  <done>
    All changed images copied to dev registry with correct SHAs and multi-arch support
  </done>
</task>

<task type="auto">
  <name>Task 3: Update QE-HANDOFF.md with v2 section</name>
  <files>.planning/phases/03-dev-release/QE-HANDOFF.md</files>
  <action>
    Update the QE handoff document with a new "v2" section showing what changed.

    **Add at the top (after the index image list):**

    ```markdown
    ---

    ## v2 Images (2026-01-22)

    **What changed from v1:**
    - FIPS compliance fix in nop image (PR #1540)
    - CPE labels added to pac and manual-approval-gate images

    **Changed Images:**
    | Image | Old SHA | New SHA |
    |-------|---------|---------|
    | pipelines-pipeline-nop-rhel8 | 01381d3d... | {new_sha} |
    | pipelines-pipelines-as-code-controller-rhel8 | 193efdd6... | {new_sha} |
    | pipelines-pipelines-as-code-watcher-rhel8 | e8fb19b9... | {new_sha} |
    | pipelines-pipelines-as-code-cli-rhel8 | {old} | {new_sha} |
    | pipelines-manual-approval-gate-controller-rhel8 | 02827dac... | {new_sha} |
    | pipelines-manual-approval-gate-webhook-rhel8 | 29430aa7... | {new_sha} |

    **Testing focus for v2:**
    - FIPS mode verification (if FIPS cluster available)
    - PAC controller/watcher functionality
    - Manual approval gate workflow

    ---
    ```

    **Fill in actual SHAs from the copy operation.**
  </action>
  <verify>
    - QE-HANDOFF.md has v2 section
    - SHAs are correct (match copied images)
    - Diff from v1 is clear
    ```bash
    cat .planning/phases/03-dev-release/QE-HANDOFF.md | grep -A20 "## v2 Images"
    ```
  </verify>
  <done>
    QE-HANDOFF.md updated with v2 section, ready for QE notification
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    - operator-update-images workflow triggered and PR merged
    - Changed images copied to dev registry
    - QE-HANDOFF.md updated with v2 section
  </what-built>
  <how-to-verify>
    1. **Verify images accessible:**
       ```bash
       skopeo inspect docker://quay.io/openshift-pipeline/pipelines-pipeline-nop-rhel8:v1.15.4 | jq '.Digest'
       ```

    2. **Verify QE handoff:**
       - Open QE-HANDOFF.md
       - Confirm v2 section shows correct SHAs
       - Confirm diff from v1 is clear

    3. **Optional: Quick deployment test:**
       ```bash
       oc apply -f - <<EOF
       apiVersion: operators.coreos.com/v1alpha1
       kind: CatalogSource
       metadata:
         name: openshift-pipelines-dev-v2
         namespace: openshift-marketplace
       spec:
         sourceType: grpc
         image: quay.io/openshift-pipeline/pipelines-index-4.18:1.15
         displayName: OpenShift Pipelines 1.15.4 Dev v2
         publisher: Red Hat
       EOF
       ```

    Type "approved" to complete phase, or describe issues.
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:
1. operator-update-images workflow succeeded
2. All changed images in dev registry
3. QE-HANDOFF.md has v2 section
4. Human verified images accessible

Final check:
```bash
# Verify nop image has FIPS fix (new SHA)
skopeo inspect docker://quay.io/openshift-pipeline/pipelines-pipeline-nop-rhel8:v1.15.4 | jq '.Digest'
# Should NOT be: sha256:01381d3d77e9eef98b85fbbbae45a0355c0aec5ee86abaa79476e0d20062c4ea
```
</verification>

<success_criteria>
- [ ] operator-update-images workflow completed
- [ ] PR merged to release-v1.15.x
- [ ] Changed images copied to quay.io/openshift-pipeline
- [ ] QE-HANDOFF.md updated with v2 section
- [ ] Human verified and approved
</success_criteria>

<output>
After completion, create `.planning/phases/03.5-dev-release-v2/03.5-03-SUMMARY.md`

Include:
- Workflow run IDs and PR numbers
- Image copy summary (old SHA vs new SHA)
- QE-HANDOFF.md update summary
- Ready status for QE testing
</output>
