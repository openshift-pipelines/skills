# Phase 3.2: Fix Snyk SAST False Positives - Research

**Researched:** 2026-01-21
**Domain:** Konflux CI/CD security scanning, Snyk SAST false positive handling
**Confidence:** MEDIUM

## Summary

Researched how to resolve Snyk SAST false positives causing Enterprise Contract (EC) failures in Konflux pipelines for the OpenShift Pipelines operator/proxy/webhook components.

**Problem context:** Snyk SAST scanner flags 15-16 "hardcoded credentials" false positives (G101 rule) when it encounters Kubernetes Secret resource names (e.g., `"tekton-results-postgres"`) and environment variable keys (e.g., `"POSTGRES_PASSWORD"`). These are NOT actual credentials, just string constants for names/keys used in the operator code.

**Key finding:** Multiple approaches exist for handling Snyk SAST false positives in Konflux, but they have different tradeoffs regarding maintainability, upstream coordination, and effectiveness.

**Primary recommendation:** Use inline `#nosec G101` comments in upstream code with clear justification, as this is the most maintainable long-term solution that travels with the code and doesn't require ongoing coordination with external systems.

## Standard Stack

### Core Technologies
| Technology | Version | Purpose | Why Standard |
|------------|---------|---------|--------------|
| Snyk Code | Latest | SAST scanning in Konflux pipelines | Integrated into Konflux build pipelines via sast-snyk-check task |
| Gosec | v2.x | Go security scanner (G101 rule) | Industry-standard Go SAST tool, Snyk uses similar detection patterns |
| Konflux | Latest | Red Hat CI/CD platform | Required platform for OpenShift component builds |
| Enterprise Contract | Latest | Policy enforcement for Konflux releases | Gates releases based on security findings |

### Supporting Tools
| Tool | Purpose | When to Use |
|------|---------|-------------|
| sast-snyk-check-oci-ta | Tekton task for Snyk SAST | Automatically runs in Konflux pipelines |
| .snyk policy file | Exclude files/directories from scanning | Monorepo scenarios, not for ignoring specific findings |
| Snyk Web UI | Organization-wide ignore management | Cross-repository consistent ignores |

### Alternative Approaches NOT Recommended
| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| Inline comments | KFP repo (gitlab.cee.redhat.com/osh/known-false-positives) | Internal Red Hat system, not publicly documented, unknown propagation time |
| Inline comments | IGNORE_FILE_PATHS pipeline parameter | Too coarse-grained, excludes entire files/directories, not specific findings |
| Inline comments | .snyk file ignores | Does NOT work for Snyk Code SAST findings, only for dependency scanning |

**Installation:**
No additional tools needed - Snyk is already integrated into Konflux pipelines.

## Architecture Patterns

### Recommended Approach: Inline Suppression Comments

The most maintainable solution is to add inline `#nosec` comments to suppress false positives directly in the source code.

#### Pattern 1: Inline #nosec with Justification
**What:** Add inline comments to suppress specific security findings at the line level
**When to use:** When you've verified a finding is a false positive and want permanent suppression
**Example:**
```go
// Source: https://securego.io/docs/rules/g101 and gosec GitHub issues
const PostgresPasswordKey = "POSTGRES_PASSWORD" // #nosec G101 -- Environment variable key name, not actual credential
const TektonResultsPostgresSecret = "tekton-results-postgres" // #nosec G101 -- Kubernetes Secret resource name, not credential value

// For multi-line or function-level suppression:
//#nosec G101 -- MD5 used for checksums only, not cryptographic security
func calculateChecksum(data []byte) string {
    return md5.Sum(data)
}
```

**Best practices:**
- Always include `--` followed by justification explaining why it's safe
- Place comment on the same line as the flagged code
- Be specific about why this is not a security issue
- Use the specific rule ID (G101) to suppress only that finding

#### Pattern 2: Snyk Web UI Organization-Level Ignores
**What:** Configure ignores via Snyk's web interface for organization-wide consistency
**When to use:** When the same false positive appears across multiple repositories
**Steps:**
1. Navigate to Group/Organization > Settings > General
2. Enable "Ignores across the repository for Snyk Code"
3. Filter specific findings and mark as ignored
4. Ignores persist across branches and all Snyk integrations

**Note:** Requires Snyk organization access and coordination

#### Pattern 3: Konflux Pipeline IGNORE_FILE_PATHS Parameter
**What:** Configure Tekton pipeline to exclude entire files/directories from scanning
**When to use:** Monorepo scenarios where different components share a repository
**Example:**
```yaml
# .tekton/operator-on-pull-request.yaml
apiVersion: tekton.dev/v1
kind: PipelineRun
spec:
  pipelineRef:
    name: docker-build-oci-ta
  params:
    - name: IGNORE_FILE_PATHS
      value: "test/,vendor/,hack/,docs/"
```

**Limitations:**
- Too coarse-grained for individual line-level false positives
- Cannot exclude specific findings, only entire files/directories
- Not suitable for operator/proxy/webhook use case (findings are in core source files)

### Anti-Patterns to Avoid

- **Using .snyk file to ignore Snyk Code findings:** The .snyk file CANNOT ignore Snyk Code SAST findings, only dependency vulnerabilities. This is documented in Snyk official docs.
- **Excluding entire source files with IGNORE_FILE_PATHS:** Don't exclude `pkg/reconciler/`, `config/`, or other critical directories just to suppress a few false positives. This would miss real security issues.
- **Relying on undocumented internal systems:** The KFP (Known False Positives) repo at gitlab.cee.redhat.com/osh/known-false-positives is not publicly documented. Format, schema, and propagation timing are unknown.
- **Ignoring without justification:** Never use `#nosec` without the `--` justification comment. Future maintainers need to understand why it was suppressed.

## Don't Hand-Roll

Problems that look simple but have existing solutions:

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Custom Snyk finding suppression system | Wrapper scripts, custom parsers | Inline #nosec comments | Gosec/Snyk natively support #nosec, custom systems break with tool updates |
| Centralized false positive database | Internal KFP-like system | Snyk Web UI Consistent Ignores | Snyk provides organization-wide ignore management with UI and API |
| Pipeline-level finding filtering | Custom Tekton task to filter results | IGNORE_FILE_PATHS for directories, #nosec for specific lines | Built into sast-snyk-check task, maintained by Konflux team |

**Key insight:** Snyk SAST false positive handling is a solved problem with multiple vendor-supported approaches. The challenge is choosing the right approach for your organization's workflow, not building custom tooling.

## Common Pitfalls

### Pitfall 1: Confusing .snyk File Capabilities
**What goes wrong:** Developers create `.snyk` files with `ignore:` sections expecting to suppress Snyk Code SAST findings, but the findings still appear.
**Why it happens:** Snyk documentation states "You cannot use the .snyk file to ignore issues in Code scans." The .snyk file only works for dependency vulnerabilities (SCA), not SAST findings.
**How to avoid:** Use inline `#nosec` comments for SAST findings, reserve .snyk files for excluding files/directories via the `exclude:` section.
**Warning signs:** Snyk scan results unchanged after adding .snyk ignore rules for G101 or other SAST findings.

### Pitfall 2: Assuming IGNORE_FILE_PATHS Works for Individual Findings
**What goes wrong:** Setting `IGNORE_FILE_PATHS: "pkg/reconciler/openshift/tektonresult/db_secret.go"` to suppress one false positive, but it excludes the entire file from scanning.
**Why it happens:** IGNORE_FILE_PATHS is designed for monorepo component separation, not finding-level suppression. It uses comma-separated file/directory paths.
**How to avoid:** Use IGNORE_FILE_PATHS only for excluding directories/files you never want scanned (e.g., `test/`, `vendor/`). For individual false positives, use inline #nosec comments.
**Warning signs:** Entire files excluded from security scanning to suppress 1-2 false positives.

### Pitfall 3: Not Documenting Why Findings Are Suppressed
**What goes wrong:** Code has `#nosec G101` comments without justification. Future security audits question whether suppressions are valid or hiding real issues.
**Why it happens:** Developers rush to "fix" EC failures without documenting the reasoning.
**How to avoid:** Always use the format `#nosec G101 -- [clear justification]`. Example: `#nosec G101 -- Environment variable key name, not credential value`.
**Warning signs:** Security team or auditors request justification for suppressions months later, original context lost.

### Pitfall 4: Upstream PR Coordination Overhead
**What goes wrong:** Adding #nosec comments to upstream TektonCD code requires PR approval, delays release timelines.
**Why it happens:** Upstream maintainers may push back on suppression comments or have different security policies.
**How to avoid:** This is unavoidable if choosing the inline comment approach for upstream code. Alternative: Wait for upstream to add suppressions themselves, or use temporary IGNORE_FILE_PATHS as stopgap (with understanding it's too broad).
**Warning signs:** PRs to upstream stuck in review for weeks, blocking release.

### Pitfall 5: Enterprise Contract Policy Misunderstanding
**What goes wrong:** Developers assume EC failures block GitHub PR merges, but PRs can still merge with `lgtm` + `approved` labels despite EC failures.
**Why it happens:** EC checks are advisory for on-PR builds but BLOCKING for release pipelines. The difference is subtle.
**How to avoid:** Understand the context: EC failures on PRs are warnings (can merge), EC failures on release pipelines are blockers (cannot release). Fix before release, not just to make PR checks green.
**Warning signs:** Team spends effort "fixing" EC failures on PRs that could have been deferred to release-time.

## Code Examples

Verified patterns from official sources:

### Suppressing Hardcoded Credential False Positives (G101)

```go
// Source: https://securego.io/docs/rules/g101
// Source: https://github.com/securego/gosec/issues/295

package reconciler

import (
    corev1 "k8s.io/api/core/v1"
)

const (
    // Secret resource names - NOT actual credentials
    TektonResultsPostgresSecret = "tekton-results-postgres" // #nosec G101 -- Kubernetes Secret resource name
    TektonResultsTLSSecret      = "tekton-results-tls"      // #nosec G101 -- Kubernetes Secret resource name

    // Environment variable keys - NOT actual credential values
    PostgresUserKey     = "POSTGRES_USER"     // #nosec G101 -- Environment variable key name
    PostgresPasswordKey = "POSTGRES_PASSWORD" // #nosec G101 -- Environment variable key name
    PostgresDBKey       = "POSTGRES_DB"       // #nosec G101 -- Environment variable key name
)

func createDatabaseSecret(namespace string, user, password, db string) *corev1.Secret {
    return &corev1.Secret{
        ObjectMeta: metav1.ObjectMeta{
            Name:      TektonResultsPostgresSecret,
            Namespace: namespace,
        },
        Data: map[string][]byte{
            PostgresUserKey:     []byte(user),     // Actual credential VALUES (not flagged)
            PostgresPasswordKey: []byte(password), // Actual credential VALUES (not flagged)
            PostgresDBKey:       []byte(db),
        },
    }
}
```

### Suppressing MD5 Checksum False Positives (Medium Severity)

```go
// Source: https://securego.io/docs/rules (G401/G501)

package hash

import (
    "crypto/md5" // #nosec G501 -- MD5 used for checksums only, not cryptographic security
)

// #nosec G401 -- MD5 is used for non-cryptographic checksums (file integrity), not security
func CalculateFileChecksum(data []byte) string {
    hash := md5.Sum(data)
    return fmt.Sprintf("%x", hash)
}
```

### Suppressing exec.Command in Test Files

```go
// Source: https://securego.io/docs/rules/g204

package test

import (
    "os/exec"
    "testing"
)

func TestDebugCommand(t *testing.T) {
    // #nosec G204 -- Test helper with controlled input, not user-facing
    cmd := exec.Command("kubectl", "get", "pods")
    output, err := cmd.CombinedOutput()
    // ... test assertions
}
```

### Configuring IGNORE_FILE_PATHS in Konflux Pipeline

```yaml
# Source: https://konflux-ci.dev/docs/testing/build/snyk/
# .tekton/operator-on-pull-request.yaml

apiVersion: tekton.dev/v1
kind: PipelineRun
metadata:
  name: operator-on-pull-request
  annotations:
    pipelinesascode.tekton.dev/max-keep-runs: "3"
spec:
  pipelineRef:
    name: docker-build-oci-ta
  params:
    - name: dockerfile
      value: Dockerfile
    - name: output-image
      value: quay.io/redhat-user-workloads/...
    # Ignore test directories and vendor code from Snyk SAST scan
    - name: IGNORE_FILE_PATHS
      value: "test/,vendor/,hack/tools/,docs/,examples/"
  workspaces:
    - name: workspace
      volumeClaimTemplate:
        spec:
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: 1Gi
```

**Note:** IGNORE_FILE_PATHS is comma-separated, paths are relative to repository root.

### Snyk Web UI Ignore (Manual Process)

```
No code example - this is a manual UI workflow:

1. Navigate to Snyk organization dashboard
2. Go to Settings > General > Snyk Code
3. Enable "Consistent Ignores" feature
4. In project view, filter findings by rule (e.g., "CWE-798: Hardcoded Credentials")
5. Select findings to ignore
6. Add ignore reason and expiration (optional)
7. Ignored findings sync across all branches and integrations
```

**Source:** https://docs.snyk.io/manage-risk/prioritize-issues-for-fixing/ignore-issues/consistent-ignores-for-snyk-code

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| .snyk file ignores | Inline #nosec comments for SAST | Snyk Code launch (~2020) | .snyk files cannot ignore SAST findings, breaking change for users |
| Manual Snyk CLI ignores | Consistent Ignores via Web UI | ~2023 | Organization-wide ignore management, cross-repo consistency |
| Basic #nosec | #nosec with justification | Gosec best practices evolution | Security audits require justification, #nosec alone is insufficient |
| KFP (internal Red Hat) | Unknown current status | Unknown | No public documentation found for KFP system in 2026 |

**Deprecated/outdated:**
- **Using .snyk ignore: sections for Snyk Code:** Officially documented as not supported. Only works for dependency vulnerabilities.
- **Relying on EC failures to block PR merges:** EC is advisory on PRs, blocking on releases. Workflow changed with Konflux evolution.

## Open Questions

Things that couldn't be fully resolved:

1. **KFP (Known False Positives) Repository Status**
   - What we know: Referenced as gitlab.cee.redhat.com/osh/known-false-positives in ISS-006
   - What's unclear: Format, schema, propagation timing, current status, public documentation
   - Recommendation: DO NOT rely on KFP for this phase. Use documented Snyk approaches (inline comments, Web UI ignores, or IGNORE_FILE_PATHS). If KFP is required, escalate to Red Hat Konflux team for internal documentation.

2. **Enterprise Contract Policy Exemption Mechanism**
   - What we know: EC enforces policies on Konflux release pipelines, can exclude specific policy packages/rules
   - What's unclear: Can EC policies be configured to ignore specific Snyk findings (by issue ID, file path, or rule)?
   - Recommendation: Assume EC has no granular Snyk finding exemption. Fix at source (inline #nosec) rather than trying to exempt at EC policy level.

3. **Upstream TektonCD Acceptance of #nosec Comments**
   - What we know: Upstream operator code is where the false positives exist
   - What's unclear: Will upstream maintainers accept PRs adding #nosec comments? What's their security scanning policy?
   - Recommendation: Prepare upstream PR with clear justification. If rejected, use IGNORE_FILE_PATHS as temporary workaround (acknowledging it's too broad) and revisit with upstream security team.

4. **Snyk Code vs Gosec Rule Alignment**
   - What we know: Snyk flags G101-like patterns, Gosec is separate tool with G101 rule
   - What's unclear: Does Snyk Code respect #nosec G101 comments, or only Snyk-specific annotations?
   - Recommendation: Test #nosec G101 comments in Konflux pipeline. If not respected, use Snyk Web UI ignores or IGNORE_FILE_PATHS.

## Sources

### Primary (HIGH confidence)
- [Konflux Snyk Task Documentation](https://konflux-ci.dev/docs/testing/build/snyk/) - Official Konflux documentation for sast-snyk-check task and IGNORE_FILE_PATHS parameter
- [Snyk User Docs: Ignore Issues](https://docs.snyk.io/manage-risk/prioritize-issues-for-fixing/ignore-issues) - Official Snyk documentation on ignore mechanisms
- [Snyk User Docs: Exclude Files FAQs](https://docs.snyk.io/manage-risk/prioritize-issues-for-fixing/ignore-issues/exclude-files-and-ignore-issues-faqs) - Confirmed .snyk files CANNOT ignore Snyk Code findings
- [Snyk User Docs: Consistent Ignores](https://docs.snyk.io/manage-risk/prioritize-issues-for-fixing/ignore-issues/consistent-ignores-for-snyk-code) - Organization-wide ignore feature for Snyk Code
- [Gosec G101 Rule Documentation](https://securego.io/docs/rules/g101) - Official gosec documentation for hardcoded credentials detection

### Secondary (MEDIUM confidence)
- [GitHub: gosec G101 False Positive Issues](https://github.com/securego/gosec/issues/1122) - Community-reported false positives for G101, patterns match operator findings
- [GitHub: gosec G101 Discussion](https://github.com/securego/gosec/issues/295) - Discussion of G101 rule behavior with Kubernetes Secret patterns
- [Blog: How to Fix G101 Gosec Errors](https://blog.skopow.ski/how-to-fix-the-g101-potential-hardcoded-credentials-gosec) - Verified patterns for using #nosec G101 (rate-limited during research)
- [Red Hat Docs: Enterprise Contract](https://docs.redhat.com/en/documentation/red_hat_trusted_application_pipeline/1.2/html-single/managing_compliance_with_enterprise_contract/index) - General EC documentation (no specific Snyk policy details found)
- [GitHub: enterprise-contract/ec-policies](https://github.com/enterprise-contract/ec-policies) - EC policy repository (no Snyk-specific policies found in search results)

### Tertiary (LOW confidence)
- [GitHub: Snyk Code Ignore Wrapper](https://github.com/adrianosela/snyk_code_ignore) - Community workaround for Snyk CLI limitations (indicates .snyk file limitations)
- [Medium: Snyk Ignore File Example](https://medium.com/@robert.radu.2019/snyk-ignore-file-example-9bd102a524d) - Community example of .snyk file format
- [Konflux Build Definitions Repository](https://github.com/konflux-ci/build-definitions) - Source of sast-snyk-check task (specific task definition not retrieved)

### Not Found (Research Gaps)
- **KFP Repository:** No public documentation found for gitlab.cee.redhat.com/osh/known-false-positives. Internal Red Hat resource.
- **EC Snyk Policy Integration:** No specific documentation on how EC policies handle Snyk SAST findings or exemption mechanisms.
- **2026 Best Practices:** Searches for 2026-specific guidance returned general documentation. Snyk/Konflux approaches appear stable.

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH - Konflux, Snyk, Gosec are documented and verified
- Architecture patterns: MEDIUM - Inline #nosec is industry standard, but Snyk Code support needs testing
- IGNORE_FILE_PATHS usage: HIGH - Officially documented in Konflux docs
- KFP approach: LOW - No public documentation, unknown feasibility
- EC policy exemptions: LOW - No specific Snyk integration documented
- Pitfalls: HIGH - Based on official Snyk docs and community-reported issues

**Research date:** 2026-01-21
**Valid until:** 2026-02-21 (30 days - stable tooling, but Konflux is actively developed)

**Next steps for planner:**
1. Test #nosec G101 comments in operator code to verify Snyk Code respects them
2. If #nosec works: Plan upstream PR to TektonCD operator with suppressions
3. If #nosec doesn't work: Plan Snyk Web UI ignore configuration (requires org access)
4. Fallback: Use IGNORE_FILE_PATHS for affected files (temporary, too broad)
5. Verify EC passes after implementing chosen approach
